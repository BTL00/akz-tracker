services:
  # ---------- MongoDB ----------
  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo-data:/data/db
      - ./mongo-init:/docker-entrypoint-initdb.d:ro
    environment:
      MONGO_INITDB_DATABASE: akz-tracker
    networks:
      - backend
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------- Node.js API + static file server ----------
  app:
    build:
      context: .
      dockerfile: server/Dockerfile
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      MONGO_URI: mongodb://mongo:27017/akz-tracker
      PORT: "3000"
      API_KEY: ${API_KEY:-change-me-to-a-real-secret}
    networks:
      - backend
    # Not exposed to host â€“ nginx is the entry point

  # ---------- nginx reverse proxy ----------
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot-etc:/etc/letsencrypt:ro
      - certbot-var:/var/www/certbot:ro
    depends_on:
      - app
    networks:
      - backend

  # ---------- Certbot (Let's Encrypt) ----------
  # First-time certificate issuance (run once, with stack up):
  #   docker compose run --rm certbot certonly --webroot -w /var/www/certbot \
  #     -d akz-tracker.piotrbomba.com --email your@email.com --agree-tos --no-eff-email
  # Then uncomment the HTTPS block in nginx.conf and restart nginx.
  certbot:
    image: certbot/certbot
    volumes:
      - certbot-etc:/etc/letsencrypt
      - certbot-var:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - backend

  # ---------- MongoDB backup ----------
  mongo-backup:
    build:
      context: ./mongo-backup
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      mongo:
        condition: service_healthy
    volumes:
      - ./backups:/backups
    environment:
      MONGO_URI: mongodb://mongo:27017/akz-tracker
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-7}
    networks:
      - backend

volumes:
  mongo-data:
  certbot-etc:
  certbot-var:

networks:
  backend:
